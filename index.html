<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HomeGram - Lite Online</title>
    <style>
        /* --- COCA MILK THEME --- */
        :root {
            --milk-bg: #fdfbf7;
            --milk-cream: #f3e5ab;
            --cocoa-dark: #3e2723;
            --cocoa-light: #6d4c41;
            --accent: #d7ccc8;
            --bubble-self: #6d4c41;
            --bubble-other: #ffffff;
            --shadow: 0 4px 15px rgba(62, 39, 35, 0.1);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--milk-bg); color: #3e2723; height: 100vh; overflow: hidden; display: flex; justify-content: center; align-items: center; }

        /* --- LAYOUT --- */
        #app-container { width: 100%; height: 100%; max-width: 1200px; display: flex; position: relative; background: #fff; box-shadow: var(--shadow); overflow: hidden; border-radius: 8px; }
        
        /* LOGIN */
        #login-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: var(--milk-bg); z-index: 100; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: opacity 0.5s; }
        .login-card { background: white; padding: 2.5rem; border-radius: 20px; box-shadow: var(--shadow); width: 90%; max-width: 400px; text-align: center; border: 2px solid var(--cocoa-light); }
        .input-group input { width: 100%; padding: 14px; margin-bottom: 10px; border: 2px solid var(--accent); border-radius: 12px; outline: none; }
        .btn-primary { background: var(--cocoa-light); color: white; padding: 14px 24px; border: none; border-radius: 50px; cursor: pointer; font-size: 1rem; width: 100%; font-weight: bold; }
        
        /* SIDEBAR */
        .sidebar { width: 320px; background: #fff; border-right: 1px solid var(--accent); display: flex; flex-direction: column; transition: transform 0.3s; z-index: 20; }
        .sidebar-header { padding: 15px; background: var(--cocoa-dark); color: white; display: flex; justify-content: space-between; align-items: center; }
        .user-list { flex: 1; overflow-y: auto; }
        .user-item { padding: 15px; display: flex; align-items: center; cursor: pointer; border-bottom: 1px solid #f0f0f0; }
        .user-item:hover { background: var(--milk-cream); }
        .avatar { width: 50px; height: 50px; border-radius: 50%; background: var(--cocoa-light); margin-right: 15px; object-fit: cover; }

        /* CHAT AREA */
        .chat-area { flex: 1; display: flex; flex-direction: column; background-image: radial-gradient(var(--accent) 1px, transparent 1px); background-size: 20px 20px; position: relative; }
        .chat-header { padding: 10px 20px; background: rgba(255,255,255,0.95); border-bottom: 1px solid var(--accent); display: flex; align-items: center; height: 70px; justify-content: space-between; }
        .chat-messages { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; scroll-behavior: smooth; }
        
        .message { max-width: 70%; padding: 10px 15px; border-radius: 15px; font-size: 0.95rem; word-wrap: break-word; }
        .message.sent { align-self: flex-end; background: var(--bubble-self); color: var(--milk-bg); border-bottom-right-radius: 2px; }
        .message.received { align-self: flex-start; background: var(--bubble-other); color: var(--cocoa-dark); border: 1px solid var(--accent); border-bottom-left-radius: 2px; }
        .message img { max-width: 100%; border-radius: 10px; margin-top: 5px; cursor: pointer; }
        
        /* INPUT & OVERLAYS */
        .chat-input-area { padding: 10px; background: white; border-top: 1px solid var(--accent); display: flex; align-items: center; gap: 10px; }
        .icon-btn { background: none; border: none; font-size: 1.3rem; cursor: pointer; color: var(--cocoa-light); padding: 8px; }
        .chat-input { flex: 1; padding: 12px; border-radius: 25px; border: 1px solid var(--accent); outline: none; }
        
        .recording-overlay { position: absolute; bottom: 80px; left: 50%; transform: translateX(-50%); background: var(--cocoa-dark); color: white; padding: 12px 25px; border-radius: 30px; display: none; align-items: center; gap: 15px; z-index: 50; }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 200; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 2rem; border-radius: 15px; width: 90%; max-width: 400px; text-align: center; }
        
        @media (max-width: 768px) {
            .sidebar { position: absolute; height: 100%; transform: translateX(0); width: 100%; }
            .sidebar.hidden { transform: translateX(-100%); }
            .back-btn { display: block !important; margin-right: 10px; cursor: pointer; font-size: 1.5rem;}
        }
        .back-btn { display: none; }
    </style>
</head>
<body>

    <audio id="bg-music" loop>
        <source src="https://cdn.pixabay.com/download/audio/2022/05/27/audio_1808fbf07a.mp3" type="audio/mpeg">
    </audio>

    <div id="login-screen">
        <div class="login-card">
            <h1 style="color:var(--cocoa-dark)">‚òï HomeGram</h1>
            <p style="color: #888; margin-bottom: 25px;">Online ‚Ä¢ No Storage</p>
            <div class="input-group"><input type="text" id="username-input" placeholder="Username"></div>
            <div class="input-group"><input type="password" id="password-input" placeholder="Password"></div>
            <button class="btn-primary" id="auth-btn">Log In</button>
            <p style="margin-top:15px; cursor:pointer; text-decoration:underline; font-size:0.9rem;" id="auth-switch-text">Create Account</p>
            <p id="auth-error" style="color: red; font-size: 0.8rem; margin-top: 10px;"></p>
        </div>
    </div>

    <div id="app-container" style="display: none;">
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div style="display: flex; align-items: center; gap: 10px; cursor: pointer;" id="profile-trigger">
                    <img src="https://via.placeholder.com/50" class="avatar" id="my-avatar-mini">
                    <span id="my-username-display" style="font-weight: bold;">Guest</span>
                </div>
                <div>
                     <button class="icon-btn" id="create-group-btn">‚ûï</button>
                     <button class="icon-btn" id="logout-btn">üö™</button>
                </div>
            </div>
            <div class="user-list" id="user-list"></div>
        </div>

        <div class="chat-area" id="chat-area">
            <div class="chat-header">
                <div style="display: flex; align-items: center;">
                    <span class="back-btn" id="back-to-sidebar">‚Üê</span>
                    <img src="" class="avatar" id="current-chat-avatar" style="width: 40px; height: 40px; display: none;">
                    <h4 id="current-chat-name" style="margin-left: 10px;">Select a chat</h4>
                </div>
            </div>

            <div class="chat-messages" id="messages-container">
                <div style="text-align: center; color: #aaa; margin-top: 50px;">Select a contact.</div>
            </div>

            <div class="recording-overlay" id="recording-overlay">
                <div style="width:10px; height:10px; background:red; border-radius:50%;"></div>
                <span>Recording (Max 30s)... <span id="rec-timer">0:00</span></span>
            </div>

            <div class="chat-input-area" id="input-area" style="display:none;">
                <button class="icon-btn" id="img-btn">üì∑</button>
                <input type="file" id="img-upload" hidden accept="image/*">
                <input type="text" class="chat-input" id="msg-input" placeholder="Message...">
                <button class="icon-btn" id="mic-btn">üéôÔ∏è</button>
                <button class="icon-btn" id="send-btn">‚û§</button>
            </div>
        </div>
    </div>

    <div class="modal" id="profile-modal">
        <div class="modal-content">
            <h3>Edit Profile</h3>
            <img src="" id="profile-preview-large" style="width:100px; height:100px; border-radius:50%; margin:15px auto; display:block; object-fit: cover; border: 3px solid var(--cocoa-light);">
            <div style="margin-bottom:15px;"><button onclick="document.getElementById('profile-pic-upload').click()" style="font-size:0.8rem; padding:5px 10px;">Change Photo</button></div>
            <input type="file" id="profile-pic-upload" hidden accept="image/*">
            <input type="text" id="edit-username" placeholder="Display Name" style="width:100%; padding:10px; margin-bottom:10px;">
            <button class="btn-primary" id="save-profile-btn">Save</button>
            <button class="icon-btn" style="margin-top:10px; font-size:1rem;" id="close-profile-btn">Close</button>
        </div>
    </div>

    <div class="modal" id="group-modal">
        <div class="modal-content">
            <h3>New Group</h3>
            <input type="text" id="group-name-input" placeholder="Group Name" style="width:100%; padding:10px; margin-bottom:10px;">
            <div id="group-user-selection" style="text-align: left; max-height: 200px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; margin-bottom: 10px;"></div>
            <button class="btn-primary" id="finalize-group-btn">Create</button>
            <button class="icon-btn" style="margin-top:10px; font-size:1rem;" onclick="document.getElementById('group-modal').style.display='none'">Cancel</button>
        </div>
    </div>

    <script type="module">
        // --- 1. CONFIGURATION ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, where, doc, setDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // !!! PASTE YOUR FIREBASE KEYS HERE !!!
        const firebaseConfig = {
            apiKey: "AIzaSyBYewU3i2u9MtEIJTlmehdDER3c0tsA8eU",
            authDomain: "cocogram-c205b.firebaseapp.com",
            projectId: "cocogram-c205b",
            messagingSenderId: "160329322605",
            appId: "1:160329322605:web:ea2eb45b7a02641153ef64"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- 2. DATA COMPRESSION (The Magic) ---
        // Compresses image to < 100KB to fit in Firestore
        const compressImage = (file) => {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_WIDTH = 400; // Small size for DB storage
                        const scale = MAX_WIDTH / img.width;
                        canvas.width = MAX_WIDTH;
                        canvas.height = img.height * scale;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        // Save as JPEG with 0.5 quality
                        resolve(canvas.toDataURL('image/jpeg', 0.5)); 
                    }
                }
            });
        };

        const blobToBase64 = (blob) => {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result);
                reader.readAsDataURL(blob);
            });
        };

        // --- 3. APP STATE ---
        let currentUser = null, currentChatId = null; 
        let isRegistering = false, allUsersCache = [];
        let mediaRecorder = null, audioChunks = [], recTimerInterval = null;

        document.getElementById('bg-music').volume = 0.1;

        // --- 4. AUTH ---
        const getEmail = (u) => `${u.replace(/\s+/g, '').toLowerCase()}@homegram.com`;
        
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('app-container').style.display = 'flex';
                updateUserDisplay();
                loadSidebarItems();
            } else {
                currentUser = null;
                document.getElementById('login-screen').style.display = 'flex';
                document.getElementById('app-container').style.display = 'none';
            }
        });

        document.getElementById('auth-btn').onclick = async () => {
            const user = document.getElementById('username-input').value.trim();
            const pass = document.getElementById('password-input').value;
            try {
                if (isRegistering) {
                    const cred = await createUserWithEmailAndPassword(auth, getEmail(user), pass);
                    await updateProfile(cred.user, { displayName: user });
                    await setDoc(doc(db, "users", cred.user.uid), {
                        name: user, email: getEmail(user), uid: cred.user.uid,
                        avatar: `https://ui-avatars.com/api/?name=${user}&background=6d4c41&color=fff`
                    });
                } else {
                    await signInWithEmailAndPassword(auth, getEmail(user), pass);
                }
            } catch (e) { document.getElementById('auth-error').innerText = e.message; }
        };

        document.getElementById('auth-switch-text').onclick = function() {
            isRegistering = !isRegistering;
            this.innerText = isRegistering ? "Have account? Log In" : "Create Account";
            document.getElementById('auth-btn').innerText = isRegistering ? "Create Account" : "Log In";
        };
        document.getElementById('logout-btn').onclick = () => signOut(auth);

        // --- 5. SIDEBAR ---
        function loadSidebarItems() {
            const list = document.getElementById('user-list');
            
            // Load Groups
            onSnapshot(query(collection(db, "groups"), where("members", "array-contains", currentUser.uid)), (snap) => {
                document.querySelectorAll('.group-item').forEach(e => e.remove());
                snap.forEach(d => {
                    const g = d.data();
                    const div = document.createElement('div');
                    div.className = 'user-item group-item';
                    div.innerHTML = `<img src="https://via.placeholder.com/50?text=G" class="avatar"><div class="user-info"><h4>${g.name}</h4></div>`;
                    div.onclick = () => openChat(d.id, g.name, "https://via.placeholder.com/50?text=G", true);
                    list.prepend(div);
                });
            });

            // Load Global
            if(!document.getElementById('global-item')) {
                const global = document.createElement('div');
                global.id = 'global-item';
                global.className = 'user-item';
                global.innerHTML = `<img src="https://via.placeholder.com/50?text=H" class="avatar"><div class="user-info"><h4>Global Chat</h4></div>`;
                global.onclick = () => openChat('global', 'Global Chat', "https://via.placeholder.com/50?text=H", true);
                list.appendChild(global);
            }

            // Load Users
            onSnapshot(collection(db, "users"), (snap) => {
                document.querySelectorAll('.dm-item').forEach(e => e.remove());
                allUsersCache = [];
                snap.forEach(d => {
                    const u = d.data();
                    if(u.uid === currentUser.uid) return;
                    allUsersCache.push(u);
                    const div = document.createElement('div');
                    div.className = 'user-item dm-item';
                    div.innerHTML = `<img src="${u.avatar}" class="avatar"><div class="user-info"><h4>${u.name}</h4></div>`;
                    div.onclick = () => openChat(u.uid, u.name, u.avatar, false);
                    list.appendChild(div);
                });
            });
        }

        // --- 6. CHAT ---
        let unsubMsg = null;
        function openChat(id, name, avatar, isGroup) {
            currentChatId = id;
            document.getElementById('current-chat-name').innerText = name;
            document.getElementById('current-chat-avatar').src = avatar;
            document.getElementById('current-chat-avatar').style.display = 'block';
            document.getElementById('input-area').style.display = 'flex';
            if(window.innerWidth <= 768) document.getElementById('sidebar').classList.add('hidden');

            if (unsubMsg) unsubMsg();
            let dbId = (!isGroup && id !== 'global') ? [currentUser.uid, id].sort().join('_') : id;
            document.getElementById('messages-container').dataset.dbChatId = dbId;

            const q = query(collection(db, "messages"), where("chatId", "==", dbId), orderBy("timestamp", "asc"));
            unsubMsg = onSnapshot(q, (snap) => {
                const container = document.getElementById('messages-container');
                container.innerHTML = '';
                snap.forEach(d => renderMessage(d.data()));
                container.scrollTop = container.scrollHeight;
            });
        }

        function renderMessage(msg) {
            const div = document.createElement('div');
            const isMe = msg.senderId === currentUser.uid;
            div.className = `message ${isMe ? 'sent' : 'received'}`;
            
            let content = '';
            // Renders Base64 data directly
            if (msg.type === 'text') content = `<div>${msg.text}</div>`;
            else if (msg.type === 'image') content = `<img src="${msg.mediaUrl}">`;
            else if (msg.type === 'audio') content = `üé§ Voice <div style="background:rgba(0,0,0,0.1); padding:5px; border-radius:10px; cursor:pointer;" onclick="new Audio('${msg.mediaUrl}').play()">‚ñ∂ Play</div>`;

            if(!isMe) content = `<small style="font-size:0.6rem;color:#888;">${msg.senderName}</small>` + content;
            div.innerHTML = content;
            document.getElementById('messages-container').appendChild(div);
        }

        async function sendMessage(type, content, mediaBase64 = null) {
            const dbId = document.getElementById('messages-container').dataset.dbChatId;
            if(!dbId) return;
            try {
                await addDoc(collection(db, "messages"), {
                    chatId: dbId,
                    senderId: currentUser.uid,
                    senderName: currentUser.displayName,
                    text: content,
                    mediaUrl: mediaBase64, 
                    type: type,
                    timestamp: Date.now()
                });
            } catch(e) { alert("File too big for No-Storage mode! (Max 1MB)"); }
        }

        // --- 7. INPUTS & MEDIA ---
        document.getElementById('send-btn').onclick = () => {
            const txt = document.getElementById('msg-input').value;
            if(txt) { sendMessage('text', txt); document.getElementById('msg-input').value = ''; }
        };

        // IMAGE (Compressed)
        document.getElementById('img-btn').onclick = () => document.getElementById('img-upload').click();
        document.getElementById('img-upload').onchange = async (e) => {
            if(e.target.files[0]) {
                const base64 = await compressImage(e.target.files[0]);
                sendMessage('image', '', base64);
            }
        };

        // VOICE (Base64)
        const micBtn = document.getElementById('mic-btn');
        const startRec = async () => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                mediaRecorder.start();
                audioChunks = [];
                document.getElementById('recording-overlay').style.display = 'flex';
                let s = 0; 
                recTimerInterval = setInterval(() => { 
                    s++; document.getElementById('rec-timer').innerText = `0:0${s}`;
                    if(s >= 30) stopRec(); // Limit to 30s
                }, 1000);
                mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                mediaRecorder.onstop = async () => {
                    const blob = new Blob(audioChunks, { type: 'audio/webm' });
                    const base64 = await blobToBase64(blob);
                    sendMessage('audio', '', base64);
                };
            } catch(e) { alert("Mic Error"); }
        };
        const stopRec = () => {
            if(mediaRecorder) { mediaRecorder.stop(); clearInterval(recTimerInterval); document.getElementById('recording-overlay').style.display='none'; }
        };
        micBtn.onmousedown = startRec; micBtn.onmouseup = stopRec;
        micBtn.ontouchstart = (e)=>{e.preventDefault(); startRec();}; micBtn.ontouchend = (e)=>{e.preventDefault(); stopRec();};

        // --- 8. UI UTILS ---
        function updateUserDisplay() {
            if(currentUser) {
                document.getElementById('my-username-display').innerText = currentUser.displayName;
                getDocs(query(collection(db, "users"), where("uid", "==", currentUser.uid))).then(sn => {
                    if(!sn.empty) {
                        const av = sn.docs[0].data().avatar;
                        document.getElementById('my-avatar-mini').src = av;
                        document.getElementById('profile-preview-large').src = av;
                    }
                });
            }
        }

        // Profile & Group Modals
        document.getElementById('save-profile-btn').onclick = async () => {
            const name = document.getElementById('edit-username').value;
            const file = document.getElementById('profile-pic-upload').files[0];
            let avatarBase64 = null;
            if(file) avatarBase64 = await compressImage(file);
            
            const updateData = {};
            if(name) { updateProfile(currentUser, {displayName: name}); updateData.name = name; }
            if(avatarBase64) updateData.avatar = avatarBase64;
            
            await setDoc(doc(db, "users", currentUser.uid), updateData, {merge: true});
            updateUserDisplay();
            document.getElementById('profile-modal').style.display = 'none';
        };

        document.getElementById('back-to-sidebar').onclick = () => document.getElementById('sidebar').classList.remove('hidden');
        document.getElementById('profile-trigger').onclick = () => document.getElementById('profile-modal').style.display = 'flex';
        document.getElementById('close-profile-btn').onclick = () => document.getElementById('profile-modal').style.display = 'none';
        
        document.getElementById('create-group-btn').onclick = () => {
            const list = document.getElementById('group-user-selection');
            list.innerHTML = '';
            allUsersCache.forEach(u => {
                list.innerHTML += `<div style="padding:5px; border-bottom:1px solid #eee;"><label><input type="checkbox" value="${u.uid}"> ${u.name}</label></div>`;
            });
            document.getElementById('group-modal').style.display = 'flex';
        };
        
        document.getElementById('finalize-group-btn').onclick = async () => {
            const name = document.getElementById('group-name-input').value;
            const checks = document.querySelectorAll('#group-user-selection input:checked');
            const members = [currentUser.uid];
            checks.forEach(c => members.push(c.value));
            await addDoc(collection(db, "groups"), { name, members, admin: currentUser.uid });
            document.getElementById('group-modal').style.display = 'none';
        };
    </script>
</body>
</html>
